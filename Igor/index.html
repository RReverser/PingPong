<html>

<head>
  <title>Augmented Reality Marker Detector</title>

  <script type="text/javascript" src="aruco/samples/getusermedia/libs/polyfill.js"></script> 
  
  <script type="text/javascript" src="aruco/src/cv.js"></script> 
  <script type="text/javascript" src="aruco/src/aruco.js"></script> 

  <script>
    var video, canvas, context, detector;

    function tick() {
    	requestAnimationFrame(tick);

		if (video.readyState === video.HAVE_ENOUGH_DATA) {
			context.drawImage(video, 0, 0, canvas.width, canvas.height);

			var markers = detector.detect(context.getImageData(0, 0, canvas.width, canvas.height));

			if (markers.length > 0) {
				drawCorners(markers);
				drawId(markers);
			}
		}
    }

    addEventListener('load', function() {

		navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;

		if (!navigator.getUserMedia) {
			throw new Error('Your browser does not support camera.');
		}

    	['video', 'canvas'].forEach(function(name) {
    		window[name] = document.getElementById(name);
    	});

		context = canvas.getContext('2d');

		navigator.getUserMedia({video: true}, function (stream) {
			video.src = window.webkitURL ? window.webkitURL.createObjectURL(stream) : stream;
		});

		detector = new AR.Detector();

		requestAnimationFrame(tick);
    });
    
    function drawCorners(markers){
      
      var corners, corner, i, j;
    
      context.lineWidth = 3;

      for (i = 0; i !== markers.length; ++ i){
		corners = markers[i].corners;

		context.strokeStyle = "red";
		context.beginPath();

		for (j = 0; j !== corners.length; ++ j){
		  corner = corners[j];
		  context.moveTo(corner.x, corner.y);
		  corner = corners[(j + 1) % corners.length];
		  context.lineTo(corner.x, corner.y);
		}

		context.stroke();
		context.closePath();

		context.strokeStyle = "green";
		context.strokeRect(corners[0].x - 2, corners[0].y - 2, 4, 4);
      }
      
      //console.log(markers);
    }

    function drawId(markers){
    /*
      var corners, corner, x, y, i, j;
      
      context.strokeStyle = "blue";
      context.lineWidth = 1;
      
      for (i = 0; i !== markers.length; ++ i){
        corners = markers[i].corners;
        
        x = Infinity;
        y = Infinity;
        
        for (j = 0; j !== corners.length; ++ j){
          corner = corners[j];
          
          x = Math.min(x, corner.x);
          y = Math.min(y, corner.y);
        }

        context.strokeText(markers[i].id, x, y)
      }
    */
    }
  </script>

</head>

<body>

  <center>
    <video id="video" autoplay="true" style="display:none;"></video>
    <canvas id="canvas" width="400" height="300"></canvas>
  </center>

</body>
  
</html>